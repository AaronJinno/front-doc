---
title: "2-4. JS的异步执行"
date: 2023-04-18
---
:::tip
在 H5 中，对于 script 元素，新增 ==async== 属性与 ==defer== 属性，它们的作用都是加快页面的加载速度，使脚本代码的读取不再妨碍页面上其他元素的加载。
:::

#### 1. 页面文档的渲染机制
- 浏览器通过HTTP协议请求服务器，获取HMTL文档并开始从上到下解析，构建DOM。
- 在构建DOM过程中，如果遇到 ==外联== 的样式声明和脚本声明，则暂停文档解析，创建新的网络连接，并开始下载样式文件和脚本文件。
- 样式文件下载完成后，构建CSSDOM；脚本文件下载完成后，解释并执行，然后继续解析文档构建DOM 。
- 完成文档解析后，将DOM和CSSDOM进行关联和映射，最后将视图渲染到浏览器窗口。

#### 2. 默认渲染机制的缺点
如果脚本文件比较庞大，则该脚本文件的下载工作无疑会成为页面加载时的一个性能方面的瓶颈。

#### 3. defer和async的作用
两个属性都是在加载页面的同时下载脚本文件。
- defer：用于开启新的线程下载脚本文件，并使脚本在文档解析完成后执行。
- async：用于异步下载脚本文件，下载完毕立即解释执行代码。

#### 4. 图解页面文档加载的三种方式
PS: 绿色线是页面解析；蓝色线是JS下载；红色线是JS执行 。 

![2-4-1](/img/basic/html/2-4-1.png)

#### 5. async与defer基本语法
```html
<script async src="myAsyncScript.js" onload="myAsyncInit()"></script>
<script defer src="myDeferScript.js" onload="myDeferInit()"></script>
```
PS：onload是下载时触发的事件，不是必须的。

#### 6. async与defer的区别
- async：脚本加载后，立即执行事件处理函数，如果页面中使用多个外部脚本，且均为这些外部脚本文件使用 async 属性，则这些脚本的 onload 事件处理函数执行顺序并不与外部脚本文件的引用顺序保持一致，一旦某个外部脚本文件下载完毕，立即执行该脚本文件的 onload 事件处理函数。
- defer：脚本下载后，不立即执行该脚的 onload 事件处理函数，而是等到页面全部加载完毕后，才执行onload 事件处理函数，如果页面中使用多个外部脚本文件，且均为这些外部脚本文件使用defer 属性，则在页面加载后按这文件的引用顺序来执行外部脚本文件的 onload 事件处理函数。

#### 7. onload事件
由于外部脚本文件的下载工作也属于整个页面的加载工作中的一部分，所以外部脚本文件的 onload 事件处理函数将始终在浏览器窗口对象的 onload 事件处理函数或页面的 body 元素的 onload 事件处理函数之前 **首先被执行**。

#### 8. 使用注意
- async
    - 只适用于外联脚本，这一点和defer一致；
    - 如果有多个声明了async的脚本，其下载和执行也是异步的，不能确保彼此的先后顺序；
    - async会在load事件之前执行，但并不能确保与DOMContentLoaded的执行先后顺序 。
- defer
    - defer只适用于外联脚本，如果script标签没有指定src属性，只是内联脚本，不要使用defer；
    - 如果有多个声明了defer的脚本，则会按顺序下载和执行 ；
    - defer脚本会在DOMContentLoaded和load事件之前执行。